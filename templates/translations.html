<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --font: "Inter", sans-serif;
      --bg: #fff;
      --text: #111;
      --muted: #888;
      --border: #eee;
      --accent-bg: #f9f9f9;
      --success: #d4edda;
      --error: #f8d7da;
    }

    body {
      margin: 0; padding: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th, td {
      padding: 0.6rem 0.75rem;
      text-align: left;
      vertical-align: top;
    }

    th {
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    td small.key-id {
      color: var(--muted);
      font-size: 0.75rem;
    }

    tr:nth-child(even) {
      background-color: var(--accent-bg);
    }

    .editable:focus {
      outline: 2px solid #007bff;
      background-color: #eef6ff;
    }

    .lang-code {
      margin-left: 0.3rem;
      color: var(--muted);
    }

    .lang-filter {
      margin-bottom: 1rem;
    }

    #status-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      display: none;
    }

    #status-message.success {
      background-color: var(--success);
      color: #155724;
    }

    #status-message.error {
      background-color: var(--error);
      color: #721c24;
    }

    #confirm-block {
      display: none;
      margin: 1rem 0;
    }

    #confirm-block button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

  @media (min-width: 769px) {
    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }

    .table-wrapper table {
      min-width: 1000px;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü */
    .table-wrapper td:first-child,
    .table-wrapper th:first-child {
      position: sticky;
      width: 250px;
      background-color: white;
      left: 0;
      z-index: 2;
    }

    /* –ü–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —è—á–µ–µ–∫ */
    .table-wrapper th:first-child {
      z-index: 3;
    }

    .lang-col {
      width: 290px;
    }
  }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 1rem;
        padding: 0.5rem;
        border: 1px solid var(--border);
        background: var(--bg);
      }

      td {
        flex-direction: column;
        align-items: flex-start;
        padding: 0.5rem 0;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 0.25rem;
        margin-right: 0.45rem;
        font-size: 0.8rem;
      }

      td small.key-id {
        display: none;
      }

      .lang-code {
        display: none;
      }
    }
  </style>
</head>
<body>

  {% extends "base.html" %}

  {% block title %}–ü–µ—Ä–µ–≤–æ–¥—ã ‚Äì –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

  {% block content %}

  <h1>üìò –ü–µ—Ä–µ–≤–æ–¥—ã</h1>

  <div class="lang-filter">
    <label for="lang-select">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —è–∑—ã–∫–∞:</label>
    <select id="lang-select">
      <option value="all">–í—Å–µ</option>
      {% for lang in langs %}
        <option value="{{ lang.code }}">{{ flags.get(lang.code, "üè≥") }} {{ lang.name_ru }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="lang-filter">
    <form method="get">
      <label for="add-lang">–î–æ–±–∞–≤–∏—Ç—å —è–∑—ã–∫:</label>
      <select name="add" id="add-lang">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫...</option>
        {% for lang in missing_langs %}
          <option value="{{ lang.code }}">{{ flags.get(lang.code, "üè≥") }} {{ lang.name_ru }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <div id="status-message"></div>
  <div id="confirm-block">
    <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É?</p>
    <button id="confirm-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

<div class="table-wrapper">
  <table>
    <thead>
        <tr>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          {% for lang in langs %}
            <th class="lang-head lang-col" data-lang-code="{{ lang.code }}">
              {{ flags.get(lang.code, "üè≥") }} <span class="lang-code">{{ lang.name_ru }}</span>
            </th>
          {% endfor %}
        </tr>
    </thead>
    <tbody>
      {% for key, row in translations.items() %}
        <tr>
            <td data-label="–û–ø–∏—Å–∞–Ω–∏–µ">
                <strong>{{ key_descriptions.get(key, '‚Äî') }}</strong><br>
                <small class="key-id">{{ key }}</small>
            </td>
          {% for lang in langs %}
          <td class="lang-col editable" data-lang-code="{{ lang.code }}"
              data-label="{{ flags.get(lang.code, 'üè≥') }}"
              contenteditable="true"
              data-key="{{ key }}"
              data-lang="{{ lang.code }}">
              {{ row.get(lang.code, '') }}
          </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function showMessage(text, type = 'success') {
    const el = document.getElementById("status-message");
    el.textContent = text;
    el.className = "";
    el.classList.add(type === 'error' ? 'error' : 'success');
    el.style.display = "block";
  }

  document.addEventListener("DOMContentLoaded", () => {
    const langSelect = document.getElementById("lang-select");
    langSelect.addEventListener("change", () => {
      const selected = langSelect.value;
      document.querySelectorAll(".lang-col").forEach(col => {
        const colLang = col.dataset.langCode;
        col.style.display = (selected === "all" || selected === colLang) ? "table-cell" : "none";
      });
    });

    // –ü–†–ò –í–´–ë–û–†–ï –Ø–ó–´–ö–ê: –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É
    const addLangSelect = document.getElementById("add-lang");
    if (addLangSelect) {
      addLangSelect.addEventListener("change", () => {
        const selected = addLangSelect.value;
        if (selected) {
          showMessage("üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ ChatGPT...");
          // –ü–µ—Ä–µ—Ö–æ–¥ —Å ?add=...
          const url = new URL(window.location.href);
          url.searchParams.set("add", selected);
          window.location.href = url.toString();
        }
      });
    }

    const params = new URLSearchParams(window.location.search);
    const addLang = params.get("add");

    // –ö–æ–≥–¥–∞ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª–æ—Å—å –ø–æ—Å–ª–µ GPT
    window.addEventListener("load", () => {
      if (addLang) {
        document.getElementById("confirm-block").style.display = "block";
        showMessage("‚úÖ –ü–µ—Ä–µ–≤–æ–¥—ã –ø–æ–ª—É—á–µ–Ω—ã. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.");
        let isSaving = false;

        document.getElementById("confirm-save").addEventListener("click", async () => {
          if (isSaving) return;
          isSaving = true;

          const button = document.getElementById("confirm-save");
          button.disabled = true;
          const originalText = button.innerText;
          button.innerText = "‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...";

          const lang = "{{ selected_lang.code }}";
          const cells = document.querySelectorAll(`[data-lang="${lang}"]`);
          const translations = {};

          cells.forEach(cell => {
            const key = cell.dataset.key;
            const raw = cell.innerText.trim();
            if (raw) {
              const text = raw.replace(/\n{3,}/g, "\n\n").replace(/\n/g, "\\n");
              translations[key] = text;
            }
          });

          try {
            const res = await fetch("/translations/save", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ lang, translations })
            });

            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");

            showMessage("‚úÖ –ü–µ—Ä–µ–≤–æ–¥—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            setTimeout(() => {
              const cleanUrl = window.location.origin + window.location.pathname;
              window.location.href = cleanUrl;
            }, 1500);
          } catch (err) {
            showMessage("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞", "error");
            button.disabled = false;
            button.innerText = originalText;
            isSaving = false;
          }
        });
      }
    });

    document.querySelectorAll(".editable").forEach(cell => {
      cell.addEventListener("blur", async () => {
        const key = cell.dataset.key;
        const lang = cell.dataset.lang;
        const rawText = cell.innerText.trim();
        const text = rawText.replace(/\n{3,}/g, "\n\n").replace(/\n/g, "\\n");

        try {
          const res = await fetch("/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, lang, text })
          });
          if (!res.ok) throw new Error();
          showMessage("‚úÖ –ü–µ—Ä–µ–≤–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
          setTimeout(() => window.location.reload(), 1000);
        } catch {
          showMessage("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å", "error");
        }
      });
    });
  });
</script>

  {% endblock %}
</body>
</html>